<!-- chat.html (FIXED) -->
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>Fixif.ai Â· Vehicle AI Diagnosis Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    html[data-theme="light"]{
      --bg:#f4f4f5;--bg-alt:#ffffff;--bg-soft:#e5e5e5;--border-subtle:rgba(148,148,148,.4);
      --text:#111;--text-muted:#4b4b4b;--text-soft:#9f9f9f;--text-on-accent:#f9f9f9;
      --accent:#2f2f2f;--accent-soft:rgba(47,47,47,.08);--accent-strong:#000;
      --shadow-soft:0 18px 45px rgba(15,15,15,.16);--shadow-elevated:0 22px 55px rgba(15,15,15,.25);
      --header-blur-bg:rgba(249,249,249,.94);--hero-gradient:radial-gradient(circle at top,#e5e5e5 0%,#f9f9f9 38%,#f9f9f9 100%);
    }
    html[data-theme="dark"]{
      --bg:#050505;--bg-alt:#050505;--bg-soft:#111;--border-subtle:rgba(148,148,148,.35);
      --text:#f5f5f5;--text-muted:#d4d4d4;--text-soft:#9f9f9f;--text-on-accent:#050505;
      --accent:#e5e5e5;--accent-soft:rgba(229,229,229,.06);--accent-strong:#fff;
      --shadow-soft:0 18px 45px rgba(0,0,0,.9);--shadow-elevated:0 24px 65px rgba(0,0,0,1);
      --header-blur-bg:rgba(5,5,5,.92);--hero-gradient:radial-gradient(circle at top,#050505 0%,#050505 40%,#050505 100%);
    }
    html{
      --bg:#050505;--bg-alt:#050505;--bg-soft:#111;--border-subtle:rgba(148,148,148,.35);
      --text:#f5f5f5;--text-muted:#d4d4d4;--text-soft:#9f9f9f;--text-on-accent:#050505;
      --accent:#e5e5e5;--accent-soft:rgba(229,229,229,.06);--accent-strong:#fff;
      --shadow-soft:0 18px 45px rgba(0,0,0,.9);--shadow-elevated:0 24px 65px rgba(0,0,0,1);
      --header-blur-bg:rgba(5,5,5,.92);--hero-gradient:radial-gradient(circle at top,#050505 0%,#050505 40%,#050505 100%);
    }
    :root{
      --radius-lg:1.25rem;--radius-md:.75rem;--radius-sm:.5rem;--radius-pill:999px;
      --header-height:72px;--content-max-width:1120px;
    }

    *,:before,:after{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);color:var(--text);min-height:100vh;
    }
    h1,h2,h3,h4{margin:0;font-weight:700;letter-spacing:.02em}
    p{margin:0;line-height:1.7}
    a{color:inherit}

    .container{max-width:var(--content-max-width);margin:0 auto;padding:0 1.5rem}
    .page{min-height:100vh;display:flex;flex-direction:column}
    main{flex:1}

    .site-header{
      position:sticky;top:0;z-index:40;backdrop-filter:blur(18px);
      background:var(--header-blur-bg);border-bottom:1px solid var(--border-subtle);
    }
    .header-inner{
      height:var(--header-height);display:flex;align-items:center;justify-content:space-between;gap:1.25rem;
    }
    .brand{display:flex;align-items:center;gap:.75rem;text-decoration:none}
    .brand-mark{
      width:32px;height:32px;border-radius:.9rem;
      background:radial-gradient(circle at 0 0,var(--accent),var(--accent-strong));
      display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.9rem;color:var(--text-on-accent);
      box-shadow:0 0 0 1px rgba(0,0,0,.8),0 0 24px rgba(0,0,0,.45);
    }
    .brand-text{display:flex;flex-direction:column;gap:.05rem}
    .brand-name{text-transform:uppercase;font-size:.9rem;letter-spacing:.18em}
    .brand-tagline{font-size:.75rem;color:var(--text-muted)}
    .site-nav{display:flex;align-items:center;gap:1.5rem}
    .nav-link{
      text-decoration:none;font-size:.85rem;text-transform:uppercase;letter-spacing:.16em;color:var(--text-muted);
      position:relative;padding-bottom:.2rem;
    }
    .nav-link:after{
      content:"";position:absolute;left:0;bottom:-.25rem;width:0;height:2px;border-radius:999px;
      background:linear-gradient(to right,var(--accent),var(--accent-strong));transition:width .16s ease;
    }
    .nav-link:hover:after{width:100%}
    .nav-link.is-active{color:var(--accent-strong)}
    .nav-link.is-active:after{width:100%}

    .header-actions{display:flex;align-items:center;gap:.75rem}
    .theme-toggle{
      border-radius:var(--radius-pill);padding:.35rem .9rem;border:1px solid var(--border-subtle);
      background:var(--bg-soft);display:inline-flex;align-items:center;gap:.35rem;font-size:.78rem;
      cursor:pointer;text-transform:uppercase;letter-spacing:.12em;color:var(--text);
    }
    html[data-theme="dark"] .theme-toggle{color:#fff}
    .theme-toggle-icon{font-size:.9rem}
    .nav-toggle{
      display:none;width:38px;height:38px;border-radius:999px;border:1px solid var(--border-subtle);
      background:var(--bg-soft);padding:0;justify-content:center;align-items:center;flex-direction:column;gap:5px;
    }
    .nav-toggle span{width:16px;height:2px;border-radius:999px;background:var(--text-muted)}

    .hero{
      background:var(--hero-gradient);position:relative;overflow:hidden;padding:1.35rem 0 1.25rem;
      border-bottom:1px solid var(--border-subtle);
    }
    .hero-inner{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;flex-wrap:wrap}
    .hero-title{font-size:clamp(1.6rem,2.6vw,2.1rem);margin-bottom:.35rem}
    .hero-subtext{color:var(--text-muted);max-width:52rem}

    .welcome-top{
      display:flex;align-items:center;gap:.85rem;justify-content:flex-end;min-width:320px;
    }
    .welcome-logo{
      width:56px;height:56px;border-radius:18px;overflow:hidden;border:1px solid var(--border-subtle);
      background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;flex-shrink:0;
    }
    .welcome-logo img{width:100%;height:100%;object-fit:cover;display:none}
    .welcome-logo span{font-weight:900;opacity:.92}
    .welcome-title{
      font-size:clamp(1.75rem,2.6vw,2.45rem);
      font-weight:900;letter-spacing:.02em;line-height:1.05;text-align:right;white-space:nowrap;
    }
    .welcome-sub{
      color:var(--text-muted);margin-top:.35rem;font-size:.9rem;letter-spacing:.14em;
      text-transform:uppercase;text-align:right;white-space:nowrap;
    }

    .section{padding:2.2rem 0}
    .section-header{margin-bottom:1.4rem}
    .section-kicker{font-size:.8rem;text-transform:uppercase;letter-spacing:.18em;color:var(--accent-strong);margin-bottom:.35rem}
    .section-title{font-size:1.5rem;margin-bottom:.35rem}
    .section-subtitle{max-width:50rem;color:var(--text-muted)}

    .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.9rem}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.9rem}

    .card{
      border-radius:var(--radius-lg);border:1px solid var(--border-subtle);background:var(--bg-alt);
      padding:1.2rem 1.25rem;box-shadow:var(--shadow-soft);display:flex;flex-direction:column;
    }
    .btn{
      border-radius:var(--radius-pill);border:1px solid var(--border-subtle);padding:.6rem 1.2rem;
      font-size:.85rem;text-transform:uppercase;letter-spacing:.12em;font-weight:500;
      display:inline-flex;align-items:center;justify-content:center;gap:.4rem;cursor:pointer;
      background:var(--bg-alt);color:var(--text);text-decoration:none;
    }
    .btn-primary{
      background:linear-gradient(to right,var(--accent),var(--accent-strong));border-color:transparent;color:var(--text-on-accent);
      box-shadow:0 14px 32px rgba(0,0,0,.32);
    }
    .btn-ghost{background:var(--bg-alt)}
    .btn-soft{
      border-radius:var(--radius-pill);border:1px dashed var(--border-subtle);padding:.45rem .95rem;
      font-size:.78rem;letter-spacing:.08em;text-transform:uppercase;background:var(--bg-soft);
      color:var(--text-soft);cursor:pointer;
    }
    .btn-danger{border-color:rgba(248,113,113,.55);background:rgba(248,113,113,.08);color:#fecaca}
    .btn-success{border-color:rgba(34,197,94,.55);background:rgba(34,197,94,.10);color:#bbf7d0}

    .site-footer{border-top:1px solid var(--border-subtle);padding:1.6rem 0;font-size:.8rem;color:var(--text-soft)}
    .footer-inner{display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
    .footer-links{display:flex;gap:1.25rem}
    .footer-links a{text-decoration:none;font-size:.78rem;text-transform:uppercase;letter-spacing:.14em}

    @media (max-width:768px){
      .site-nav{
        position:absolute;inset:var(--header-height) 0 auto 0;background:var(--header-blur-bg);
        border-bottom:1px solid var(--border-subtle);
        flex-direction:column;align-items:flex-start;gap:.75rem;padding:.8rem 1.5rem 1rem;
        transform:translateY(-140%);opacity:0;pointer-events:none;transition:transform .16s ease-out,opacity .16s ease-out;
      }
      .site-nav.is-open{transform:translateY(0);opacity:1;pointer-events:auto}
      .nav-toggle{display:inline-flex}
      .header-inner{padding-inline:1.2rem}
      .grid-3,.grid-2{grid-template-columns:minmax(0,1fr)}
      .welcome-top{justify-content:flex-start;min-width:unset}
      .welcome-title,.welcome-sub{text-align:left;white-space:normal}
    }

    .assistant-top{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;flex-wrap:wrap;margin-bottom:1rem}
    .lookup-row{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
    .lookup-row input{min-width:240px;flex:1}

    .status-tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.8rem}
    .status-chip{
      border-radius:999px;border:1px solid var(--border-subtle);padding:.35rem .7rem;font-size:.72rem;
      text-transform:uppercase;letter-spacing:.12em;color:var(--text-muted);cursor:pointer;background:var(--bg-alt);user-select:none;
    }
    .status-chip.active{color:var(--accent-strong);border-color:rgba(148,148,148,.75);box-shadow:0 0 0 1px rgba(0,0,0,.25)}
    .workflow-note{
      margin-top:.75rem;border-radius:var(--radius-md);border:1px dashed var(--border-subtle);
      background:var(--bg-soft);padding:.75rem .85rem;color:var(--text-muted);font-size:.9rem;line-height:1.6;
    }

    .chat-layout{display:grid;grid-template-columns:minmax(0,1.2fr) minmax(0,1fr);gap:1.5rem;align-items:flex-start}
    @media (max-width:900px){.chat-layout{grid-template-columns:minmax(0,1fr)}}

    fieldset{border:none;padding:0;margin:0 0 1rem}
    label{font-size:.75rem;text-transform:uppercase;letter-spacing:.12em;color:var(--text-soft)}
    input,textarea,select{
      width:100%;border-radius:var(--radius-md);border:1px solid var(--border-subtle);
      padding:.55rem .7rem;background:var(--bg);color:var(--text);font-size:.9rem;outline:none;
    }
    input:focus,textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 1px rgba(0,0,0,.25)}

    .section-label{display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin-bottom:.4rem}
    .section-label .left{display:flex;align-items:center;gap:.5rem;font-size:.78rem;text-transform:uppercase;letter-spacing:.16em;color:var(--text-soft)}
    .step-badge{
      display:inline-flex;align-items:center;justify-content:center;min-width:1.4rem;height:1.4rem;
      border-radius:999px;border:1px solid var(--border-subtle);font-size:.72rem;font-weight:600;color:var(--text-soft);
    }
    .inline-actions{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;justify-content:flex-end}
    .hint{font-size:.78rem;color:var(--text-soft);margin-top:.35rem}
    .status-msg{margin-top:.7rem;font-size:.85rem}
    .status-msg.error{
      color:#fecaca;background:rgba(248,113,113,.08);
      border-radius:var(--radius-md);padding:.55rem .65rem;border:1px solid rgba(248,113,113,.35);
    }
    .status-msg.loading{color:var(--accent-strong)}

    .result-placeholder{font-size:.9rem;color:var(--text-soft)}
    .result-block{
      border-radius:var(--radius-md);border:1px solid var(--border-subtle);background:var(--bg);
      padding:.8rem .9rem;margin-bottom:.8rem;
    }
    .result-block h3{
      font-size:.92rem;margin:0 0 .35rem;text-transform:uppercase;letter-spacing:.12em;color:var(--accent-strong);
    }
    .result-text{font-size:.92rem;color:var(--text-muted);line-height:1.6}

    .kv{display:grid;grid-template-columns:minmax(0,1fr);gap:.6rem}
    .kv-row{display:grid;grid-template-columns:1fr 1fr;gap:.7rem}
    @media (max-width:560px){.kv-row{grid-template-columns:1fr}}

    .pill{
      border-radius:999px;padding:.1rem .55rem;font-size:.65rem;text-transform:uppercase;letter-spacing:.12em;
      border:1px solid var(--border-subtle);color:var(--text-soft);display:inline-flex;align-items:center;justify-content:center;
      gap:.35rem;white-space:nowrap;
    }

    .cause-item{
      border-radius:var(--radius-md);background:var(--bg-alt);padding:.65rem .7rem;margin-bottom:.6rem;border:1px solid var(--border-subtle);
    }
    .cause-header{display:flex;align-items:flex-start;justify-content:space-between;gap:.6rem;margin-bottom:.35rem}
    .cause-title{font-size:.98rem;font-weight:700;color:var(--text)}
    .likelihood-high{border:2px solid rgba(248,113,113,.8)}
    .likelihood-medium{border:2px solid rgba(251,146,60,.8)}
    .likelihood-low{border:2px solid rgba(34,197,94,.55)}

    .divider{height:1px;background:var(--border-subtle);margin:.8rem 0}
    .result-actions{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.7rem}
    .linkish{
      font-size:.82rem;color:var(--accent-strong);text-decoration:none;border-bottom:1px solid rgba(148,148,148,.55);
      padding-bottom:2px;cursor:pointer;
    }
    .meta-line{margin-top:.55rem;font-size:.78rem;color:var(--text-soft)}
    .file-input{
      padding:.55rem .7rem;border-radius:var(--radius-md);border:1px dashed var(--border-subtle);
      background:var(--bg-soft);color:var(--text-soft);font-size:.9rem;
    }
    pre{
      white-space:pre-wrap;word-wrap:break-word;font-size:.78rem;background:var(--bg);padding:.6rem;border-radius:var(--radius-md);
      border:1px solid var(--border-subtle);max-height:260px;overflow:auto;margin:0;
    }

    .progress-wrap{display:flex;flex-direction:column;gap:.45rem}
    .progress-top{display:flex;align-items:center;justify-content:space-between;gap:.75rem}
    .progress-track{
      height:10px;border-radius:999px;border:1px solid var(--border-subtle);background:rgba(255,255,255,.05);overflow:hidden;
    }
    .progress-bar{
      height:100%;
      width:0%;
      background:linear-gradient(to right,var(--accent),var(--accent-strong));
      border-radius:999px;
      transition:width .18s ease;
    }
    .progress-pct{font-size:.82rem;color:var(--text-muted);white-space:nowrap}

    .disclaimer{
      margin-top:.85rem;
      border-radius:var(--radius-md);
      border:1px dashed var(--border-subtle);
      background:var(--bg-soft);
      padding:.75rem .85rem;
      color:var(--text-muted);
      font-size:.85rem;
      line-height:1.55;
    }
  </style>
</head>

<body>
  <div class="page">
    <header class="site-header">
      <div class="container header-inner">
        <a href="index.html" class="brand">
          <div class="brand-mark">Fx</div>
          <div class="brand-text">
            <div class="brand-name">FIXIF.AI</div>
            <div class="brand-tagline">Vehicle issue intake &amp; triage</div>
          </div>
        </a>

        <nav class="site-nav" id="site-nav">
          <a href="index.html" class="nav-link">Home</a>
          <a href="chat.html" class="nav-link is-active">AI Assistant</a>
          <a href="login.html" class="nav-link" id="logoutLink">Logout</a>
        </nav>

        <div class="header-actions">
          <button class="theme-toggle" id="theme-toggle" type="button">
            <span class="theme-toggle-icon" id="theme-toggle-icon">ðŸŒ™</span>
            <span class="theme-toggle-label" id="theme-toggle-label">Dark</span>
          </button>
          <button class="nav-toggle" id="nav-toggle" type="button" aria-label="Toggle navigation">
            <span></span><span></span><span></span>
          </button>
        </div>
      </div>
    </header>

    <main>
      <section class="hero">
        <div class="container">
          <div class="hero-inner">
            <div class="welcome-top">
              <div class="welcome-logo">
                <img id="businessLogoImg" src="" alt="Logo" />
                <span id="businessLogoFallback">Fx</span>
              </div>
              <div>
                <div class="welcome-title" id="welcomeTitle">Welcome, â€”</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="section" id="assistant">
        <div class="container">
          <div class="section-header">
            <div class="section-kicker">Interactive workspace</div>
            <h2 class="section-title">Service intake &amp; AI draft</h2>
            <p class="section-subtitle">
              Look up by phone first. If the customer exists, details and history will auto-fill. If not, fields stay blank.
            </p>
          </div>

          <div class="card" style="margin-bottom:1.2rem;">
            <div class="assistant-top">
              <div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
                <div>
                  <div style="font-size:.78rem; text-transform:uppercase; letter-spacing:.16em; color:var(--text-soft);">
                    Business profile
                  </div>
                  <div class="hint" style="margin-top:.35rem; max-width:34rem;">
                    Upload logo / change business name to update the Welcome header.
                  </div>

                  <div class="mini-actions" style="margin-top:0.6rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
                    <input id="logoInput" type="file" accept="image/jpeg,image/png,image/webp" style="display:none;" />
                    <button class="btn btn-ghost" type="button" id="uploadLogoBtn">Upload Logo</button>
                    <button class="btn btn-ghost" type="button" id="editBusinessNameBtn">Edit Business Name</button>
                  </div>
                </div>
              </div>

              <div class="lookup-row">
                <input id="lookupPhone" type="text" placeholder="Enter Phone Number" />
                <button class="btn btn-primary" type="button" id="lookupBtn">Lookup</button>
                <button class="btn btn-ghost" type="button" id="newCustomerBtn">New Intake</button>
              </div>
            </div>

            <div class="status-tabs" role="tablist" aria-label="Job status">
              <div class="status-chip active" data-status="in_progress" id="statusChipInProgress">In Progress</div>
              <div class="status-chip" data-status="completed" id="statusChipCompleted">Completed</div>
              <div class="status-chip" data-status="cancelled" id="statusChipCancelled">Cancelled</div>
            </div>

            <div class="workflow-note" id="workflowNote">
              <strong>In Progress</strong><br/>
              â€¢ Job created and AI diagnostic generated<br/>
              â€¢ Mechanic is reviewing/editing AI suggestions (tests, labor, notes)
            </div>

            <div id="topStatus" class="status-msg" style="margin-top:0.8rem;"></div>
          </div>

          <div class="chat-layout">
            <!-- LEFT: FORM -->
            <section class="card">
              <form id="intakeForm">
                <!-- Customer Details -->
                <fieldset>
                  <div class="section-label">
                    <div class="left">
                      <span class="step-badge">1</span>
                      <span>Customer Details</span>
                    </div>
                    <div class="inline-actions">
                      <span class="pill" id="repeatCustomerPill" style="display:none;">Repeat Customer</span>
                    </div>
                  </div>

                  <div class="grid-2">
                    <div>
                      <label for="fullName">Full Name</label>
                      <input type="text" id="fullName" name="fullName" placeholder="Customer full name" />
                    </div>
                    <div>
                      <label for="phone">Phone Number</label>
                      <input type="text" id="phone" name="phone" placeholder="09xxxxxxxxx" />
                    </div>
                  </div>

                  <div class="grid-2" style="margin-top:0.9rem;">
                    <div>
                      <label for="email">Email</label>
                      <input type="email" id="email" name="email" placeholder="Optional" />
                    </div>
                    <div>
                      <label for="preferredContactMethod">Preferred Contact Method</label>
                      <select id="preferredContactMethod" name="preferredContactMethod">
                        <option value="text" selected>Text</option>
                        <option value="email">Email</option>
                      </select>
                    </div>
                  </div>

                  <div class="hint" id="historyHint" style="display:none;"></div>

                  <div id="repeatExtras" style="display:none; margin-top:0.9rem;">
                    <div class="grid-2" style="gap:0.9rem;">
                      <div>
                        <label for="vehicleSelect">Vehicle(s) on file</label>
                        <select id="vehicleSelect">
                          <option value="">Select vehicle</option>
                        </select>
                        <div class="hint" id="vehicleSelectHint" style="margin-top:0.5rem;"></div>
                      </div>

                      <div>
                        <label>History</label>
                        <div id="historyList" style="display:flex; flex-direction:column; gap:0.6rem;"></div>
                        <div class="hint" id="historyListHint" style="margin-top:0.5rem;"></div>
                      </div>
                    </div>
                  </div>
                </fieldset>

                <!-- Vehicle Details -->
                <fieldset>
                  <div class="section-label">
                    <div class="left">
                      <span class="step-badge">2</span>
                      <span>Vehicle Details</span>
                    </div>
                    <div class="inline-actions">
                      <button type="button" class="btn-soft" id="decodeVinBtn">Decode VIN</button>
                    </div>
                  </div>

                  <div class="grid-2">
                    <div>
                      <label for="vin">VIN (optional)</label>
                      <input type="text" id="vin" name="vin" placeholder="17-character VIN (optional)" />
                    </div>
                    <div>
                      <label for="plate">Plate Number</label>
                      <input type="text" id="plate" name="plate" placeholder="ABC 1234" />
                    </div>
                  </div>

                  <div class="grid-2" style="margin-top:0.9rem;">
                    <div>
                      <label for="year">Year</label>
                      <input type="text" id="year" name="year" placeholder="e.g. 2015" />
                    </div>
                    <div>
                      <label for="make">Make</label>
                      <input type="text" id="make" name="make" placeholder="e.g. Toyota" />
                    </div>
                  </div>

                  <div class="grid-2" style="margin-top:0.9rem;">
                    <div>
                      <label for="model">Model</label>
                      <input type="text" id="model" name="model" placeholder="e.g. Vios" />
                    </div>
                    <div>
                      <label for="engine">Engine</label>
                      <input type="text" id="engine" name="engine" placeholder="Auto-filled if decoded" />
                    </div>
                  </div>

                  <div class="grid-2" style="margin-top:0.9rem;">
                    <div>
                      <label for="transmission">Transmission</label>
                      <select id="transmission" name="transmission">
                        <option value="" selected>â€”</option>
                        <option value="AT">AT</option>
                        <option value="MT">MT</option>
                        <option value="CVT">CVT</option>
                        <option value="DCT">DCT</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                    <div>
                      <label for="dropOffDate">Drop-off Date</label>
                      <input type="date" id="dropOffDate" name="dropOffDate" />
                    </div>
                  </div>

                  <div class="hint" id="vinStatus"></div>
                </fieldset>

                <!-- Diagnostic Data -->
                <fieldset>
                  <div class="section-label">
                    <div class="left">
                      <span class="step-badge">3</span>
                      <span>Vehicle Diagnostic Data</span>
                    </div>
                  </div>

                  <div style="display:flex; flex-direction:column; gap:0.8rem;">
                    <div>
                      <label for="obd2Data">OBD-II Data</label>
                      <textarea id="obd2Data" name="obd2Data" rows="3" placeholder="Paste scan tool data, DTC codes, freeze frame, etc."></textarea>
                    </div>

                    <div>
                      <label for="symptoms">Describe the Symptoms</label>
                      <textarea id="symptoms" name="symptoms" rows="4" placeholder="Describe customer complaint and observed symptoms"></textarea>
                    </div>

                    <div>
                      <label for="mediaUpload">Upload a photo or video</label>
                      <input id="mediaUpload" class="file-input" type="file" accept="image/*,video/*" multiple />
                      <div class="hint">Uploads are stored locally in the browser for now; hook to your uploader later to convert to URLs.</div>
                      <div class="inline-actions" style="margin-top:0.6rem;">
                        <button class="btn btn-ghost" type="button" id="uploadMediaBtn">Upload Media</button>
                      </div>
                      <div class="hint" id="mediaUploadStatus" style="display:none; margin-top:0.5rem;"></div>
                      <div class="hint" id="mediaUrls" style="display:none; margin-top:0.5rem;"></div>
                    </div>
                  </div>
                </fieldset>

                <!-- AI Output Style -->
                <fieldset>
                  <div class="section-label">
                    <div class="left">
                      <span class="step-badge">4</span>
                      <span>AI Output Style</span>
                    </div>
                  </div>

                  <div class="grid-3">
                    <div>
                      <label for="detailLevel">Detail Level</label>
                      <select id="detailLevel" name="detailLevel">
                        <option value="Brief">Brief</option>
                        <option value="Normal">Normal</option>
                        <option value="Detailed" selected>Detailed</option>
                      </select>
                    </div>

                    <div>
                      <label for="language">Language</label>
                      <select id="language" name="language">
                        <option value="English" selected>English</option>
                        <option value="Mandarin Chinese">Mandarin Chinese</option>
                        <option value="Hindi">Hindi</option>
                        <option value="Spanish">Spanish</option>
                        <option value="French">French</option>
                        <option value="Modern Standard Arabic">Modern Standard Arabic</option>
                        <option value="Bengali">Bengali</option>
                        <option value="Portuguese">Portuguese</option>
                        <option value="Russian">Russian</option>
                        <option value="Urdu">Urdu</option>
                      </select>
                    </div>

                    <div>
                      <label for="tone">Tone</label>
                      <select id="tone" name="tone">
                        <option value="More Technical" selected>More Technical</option>
                        <option value="Professional">Professional</option>
                        <option value="Friendly &amp; simple">Friendly &amp; simple</option>
                      </select>
                    </div>
                  </div>
                </fieldset>

                <div style="display:flex; gap:0.6rem; flex-wrap:wrap; align-items:center; justify-content:flex-end;">
                  <button type="button" class="btn-soft" id="demoBtn">Use demo data</button>
                  <button type="button" class="btn btn-ghost" id="clearBtn">Clear</button>
                  <button type="button" class="btn btn-primary" id="generateBtn">Generate AI</button>
                </div>

                <div id="formStatus" class="status-msg"></div>
              </form>
            </section>

            <!-- RIGHT: RESULT -->
            <section class="card">
              <div class="section-label">
                <div class="left">
                  <span class="step-badge">â–¶</span>
                  <span>Intake Dashboard</span>
                </div>
                <div class="inline-actions">
                  <span class="pill" id="jobIdPill" style="display:none;">Job: â€”</span>
                </div>
              </div>

              <div id="resultContainer">
                <p class="result-placeholder">
                  Use Customer Lookup first, then fill intake fields and click <strong>Generate AI</strong>.
                </p>
              </div>
            </section>
          </div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container footer-inner">
        <span>Â© <span id="year"></span> Fixif.ai Â· GGH Software.</span>
        <div class="footer-links">
          <a href="index.html">Home</a>
          <a href="#assistant">Assistant</a>
        </div>
      </div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const API_BASE_URL = 'http://localhost:4000';

    const AI_MODEL_POLICY = [
      "You must:",
      "- Only use the data explicitly provided by the user or system.",
      "- Never invent vehicle faults, test results, or symptoms.",
      "- Never assume missing information.",
      "- Explicitly say â€œInsufficient dataâ€ when information is incomplete.",
      "- Prefer uncertainty over guessing.",
      "- Rank causes only when evidence supports comparison.",
      "- Clearly distinguish between estimates and confirmed facts.",
      "",
      "If a conclusion cannot be supported by the provided data, you must say so."
    ].join("\\n");

    /* =========================
       THEME + NAV
       ========================= */
    const root = document.documentElement;
    const themeToggle = document.getElementById('theme-toggle');
    const themeLabel = document.getElementById('theme-toggle-label');
    const themeIcon = document.getElementById('theme-toggle-icon');
    const navToggle = document.getElementById('nav-toggle');
    const nav = document.getElementById('site-nav');
    const logoutLink = document.getElementById('logoutLink');

    const savedTheme = localStorage.getItem('fixif-theme');
    if (savedTheme === 'light' || savedTheme === 'dark') root.setAttribute('data-theme', savedTheme);
    else root.setAttribute('data-theme', 'dark');

    function updateThemeUI(){
      const current = root.getAttribute('data-theme') || 'dark';
      if (current === 'dark') { themeLabel.textContent='Dark'; themeIcon.textContent='ðŸŒ™'; }
      else { themeLabel.textContent='Light'; themeIcon.textContent='â˜€ï¸'; }
    }
    updateThemeUI();

    themeToggle.addEventListener('click', () => {
      const current = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', current);
      localStorage.setItem('fixif-theme', current);
      updateThemeUI();
    });

    navToggle.addEventListener('click', () => nav.classList.toggle('is-open'));
    document.getElementById('year').textContent = new Date().getFullYear();

    /* =========================
       AUTH + STATUS UI
       ========================= */
    function getToken(){ return localStorage.getItem('fixifToken'); }

    function setTopStatus(msg, type){
      const el = document.getElementById('topStatus');
      el.textContent = msg || '';
      el.className = 'status-msg';
      if (!msg) return;
      if (type === 'error') el.classList.add('error');
      if (type === 'loading') el.classList.add('loading');
    }

    function setFormStatus(msg, type){
      const el = document.getElementById('formStatus');
      el.textContent = msg || '';
      el.className = 'status-msg';
      if (!msg) return;
      if (type === 'error') el.classList.add('error');
      if (type === 'loading') el.classList.add('loading');
    }

    async function ensureLoggedIn(){
      const token = getToken();
      if (!token) { window.location.href = 'login.html'; return false; }
      return true;
    }

    if (logoutLink){
      logoutLink.addEventListener('click', async (e) => {
        e.preventDefault();
        const result = await Swal.fire({
          title: 'Log out?',
          text: 'You will need to log in again to use the intake dashboard.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, log out',
          cancelButtonText: 'Cancel',
          reverseButtons: true,
        });
        if (!result.isConfirmed) return;
        localStorage.removeItem('fixifToken');
        localStorage.removeItem('fixifUser');
        window.location.href = 'login.html';
      });
    }

    async function fetchMe(){
      const token = getToken();
      if (!token) return null;
      try{
        const res = await fetch(API_BASE_URL + '/api/auth/me', { headers:{ Authorization:'Bearer ' + token } });
        if (!res.ok) return null;
        const data = await res.json();
        return data && data.user ? data.user : null;
      } catch { return null; }
    }

    async function fetchProfile(){
      const token = getToken();
      if (!token) return null;
      try{
        const res = await fetch(API_BASE_URL + '/api/profile', { headers:{ Authorization:'Bearer ' + token } });
        if (!res.ok) return null;
        const data = await res.json();
        return data && data.profile ? data.profile : null;
      } catch { return null; }
    }

    const welcomeTitle = document.getElementById('welcomeTitle');
    const businessLogoImg = document.getElementById('businessLogoImg');
    const businessLogoFallback = document.getElementById('businessLogoFallback');

    function setBusinessLogo(url){
      if (!businessLogoImg || !businessLogoFallback) return;
      if (url){
        businessLogoImg.src = url;
        businessLogoImg.style.display = 'block';
        businessLogoFallback.style.display = 'none';
      } else {
        businessLogoImg.removeAttribute('src');
        businessLogoImg.style.display = 'none';
        businessLogoFallback.style.display = 'inline';
      }
    }

    async function loadWelcome(){
      const cached = localStorage.getItem('fixifUser');
      if (cached){
        try{
          const u = JSON.parse(cached);
          const biz = u.businessName || u.name || 'â€”';
          welcomeTitle.textContent = 'Welcome, ' + biz;
        } catch {}
      }
      const me = await fetchMe();
      const profile = await fetchProfile();
      if (me) localStorage.setItem('fixifUser', JSON.stringify(me));
      const bizName = (profile && profile.businessName) || (me && (me.businessName || me.name)) || 'â€”';
      welcomeTitle.textContent = 'Welcome, ' + bizName;
      setBusinessLogo(profile && profile.logoUrl ? profile.logoUrl : '');
    }

    const uploadLogoBtn = document.getElementById('uploadLogoBtn');
    const logoInput = document.getElementById('logoInput');
    const editBusinessNameBtn = document.getElementById('editBusinessNameBtn');

    if (uploadLogoBtn && logoInput){
      uploadLogoBtn.addEventListener('click', () => logoInput.click());
      logoInput.addEventListener('change', async () => {
        const file = logoInput.files && logoInput.files[0];
        if (!file) return;

        const okType = ['image/jpeg','image/png','image/webp'].includes(file.type);
        if (!okType){
          Swal.fire('Invalid file','Logo must be JPG/PNG/WEBP.','warning');
          logoInput.value='';
          return;
        }

        try{
          uploadLogoBtn.disabled = true;
          const token = getToken();
          const fd = new FormData();
          fd.append('logo', file);

          const res = await fetch(API_BASE_URL + '/api/profile/logo', {
            method:'POST',
            headers:{ Authorization:'Bearer ' + token },
            body: fd
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok){
            Swal.fire('Upload failed', (data && (data.error || data.message)) || 'Upload failed.', 'error');
            return;
          }

          setBusinessLogo(data.logoUrl || '');
          Swal.fire('Uploaded','Logo updated.','success');
        } finally {
          uploadLogoBtn.disabled = false;
          logoInput.value='';
        }
      });
    }

    if (editBusinessNameBtn){
      editBusinessNameBtn.addEventListener('click', async () => {
        const { value } = await Swal.fire({
          title:'Business Name',
          input:'text',
          inputPlaceholder:'Enter business name',
          showCancelButton:true,
          confirmButtonText:'Save'
        });
        if (value === undefined) return;
        const name = String(value || '').trim();
        if (!name){
          Swal.fire('Invalid','Business name is required.','warning');
          return;
        }

        try{
          editBusinessNameBtn.disabled = true;
          const token = getToken();
          const res = await fetch(API_BASE_URL + '/api/profile', {
            method:'PATCH',
            headers:{ Authorization:'Bearer ' + token, 'Content-Type':'application/json' },
            body: JSON.stringify({ businessName: name })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok){
            Swal.fire('Update failed', (data && (data.error || data.message)) || 'Update failed.', 'error');
            return;
          }

          welcomeTitle.textContent = 'Welcome, ' + name;
          Swal.fire('Saved','Business name updated.','success');
        } finally {
          editBusinessNameBtn.disabled = false;
        }
      });
    }

    /* =========================
       STATUS WORKFLOW UI
       ========================= */
    let currentStatus = 'in_progress';
    const workflowNote = document.getElementById('workflowNote');
    const chipInProgress = document.getElementById('statusChipInProgress');
    const chipCompleted = document.getElementById('statusChipCompleted');
    const chipCancelled = document.getElementById('statusChipCancelled');

    function setWorkflow(status){
      currentStatus = status;
      chipInProgress.classList.toggle('active', status === 'in_progress');
      chipCompleted.classList.toggle('active', status === 'completed');
      chipCancelled.classList.toggle('active', status === 'cancelled');

      if (status === 'in_progress'){
        workflowNote.innerHTML =
          '<strong>In Progress</strong><br/>' +
          'â€¢ Job created and AI diagnostic generated<br/>' +
          'â€¢ Mechanic is reviewing/editing AI suggestions (tests, labor, notes)';
      } else if (status === 'completed'){
        workflowNote.innerHTML =
          '<strong>Completed</strong><br/>' +
          'â€¢ Mechanic approves the work<br/>' +
          'â€¢ Job is ready for repair or execution';
      } else {
        workflowNote.innerHTML =
          '<strong>Cancelled</strong><br/>' +
          'â€¢ Mechanic declines or job is voided<br/>' +
          'â€¢ Optional notes explaining why';
      }
    }
    chipInProgress.addEventListener('click', () => setWorkflow('in_progress'));
    chipCompleted.addEventListener('click', () => setWorkflow('completed'));
    chipCancelled.addEventListener('click', () => setWorkflow('cancelled'));

    /* =========================
       CUSTOMER LOOKUP
       ========================= */
    const lookupPhone = document.getElementById('lookupPhone');
    const lookupBtn = document.getElementById('lookupBtn');
    const newCustomerBtn = document.getElementById('newCustomerBtn');
    const repeatCustomerPill = document.getElementById('repeatCustomerPill');
    const historyHint = document.getElementById('historyHint');
    const repeatExtras = document.getElementById('repeatExtras');
    const vehicleSelect = document.getElementById('vehicleSelect');
    const vehicleSelectHint = document.getElementById('vehicleSelectHint');
    const historyList = document.getElementById('historyList');
    const historyListHint = document.getElementById('historyListHint');

    let lastLookupVehicles = [];

    const form = document.getElementById('intakeForm');
    const fullName = document.getElementById('fullName');
    const phone = document.getElementById('phone');
    const email = document.getElementById('email');
    const preferredContactMethod = document.getElementById('preferredContactMethod');

    const vin = document.getElementById('vin');
    const plate = document.getElementById('plate');
    const year = document.getElementById('year');
    const make = document.getElementById('make');
    const model = document.getElementById('model');
    const engine = document.getElementById('engine');
    const transmission = document.getElementById('transmission');
    const dropOffDate = document.getElementById('dropOffDate');
    const vinStatus = document.getElementById('vinStatus');

    const obd2Data = document.getElementById('obd2Data');
    const symptoms = document.getElementById('symptoms');
    const mediaUpload = document.getElementById('mediaUpload');
    const uploadMediaBtn = document.getElementById('uploadMediaBtn');
    const mediaUploadStatus = document.getElementById('mediaUploadStatus');
    const mediaUrls = document.getElementById('mediaUrls');
    let uploadedMediaUrls = [];

    const detailLevel = document.getElementById('detailLevel');
    const language = document.getElementById('language');
    const tone = document.getElementById('tone');

    if (uploadMediaBtn){
      uploadMediaBtn.addEventListener('click', async () => {
        if (!(await ensureLoggedIn())) return;
        const files = Array.from(mediaUpload.files || []);
        if (!files.length){
          Swal.fire('No files','Select photo/video first.','warning');
          return;
        }

        try{
          uploadMediaBtn.disabled = true;
          if (mediaUploadStatus){
            mediaUploadStatus.style.display='block';
            mediaUploadStatus.textContent='Uploading...';
          }

          const token = getToken();
          const fd = new FormData();
          files.slice(0,8).forEach(f => fd.append('media', f));

          const res = await fetch(API_BASE_URL + '/api/media/upload', {
            method:'POST',
            headers:{ Authorization:'Bearer ' + token },
            body: fd
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok){
            Swal.fire('Upload failed',(data && (data.error || data.message)) || 'Upload failed.','error');
            return;
          }

          uploadedMediaUrls = Array.isArray(data.urls) ? data.urls : [];
          if (mediaUrls){
            mediaUrls.style.display='block';
            mediaUrls.textContent = uploadedMediaUrls.length ? ('Uploaded: ' + uploadedMediaUrls.join(' , ')) : 'Uploaded (no URLs returned).';
          }
          if (mediaUploadStatus) mediaUploadStatus.textContent='Upload complete.';
          Swal.fire('Uploaded','Media uploaded and ready to attach to the job.','success');
        } finally {
          uploadMediaBtn.disabled = false;
        }
      });
    }

    function resetRepeatCustomerUI(){
      repeatCustomerPill.style.display='none';
      historyHint.style.display='none';
      historyHint.textContent='';
      if (repeatExtras) repeatExtras.style.display='none';
      if (vehicleSelect) vehicleSelect.innerHTML='<option value="">Select vehicle</option>';
      if (vehicleSelectHint) vehicleSelectHint.textContent='';
      if (historyList) historyList.innerHTML='';
      if (historyListHint) historyListHint.textContent='';
      lastLookupVehicles = [];
    }

    function clearIntake(keepLookupPhone=true){
      form.reset();
      setFormStatus('','');
      vinStatus.textContent='';
      resetRepeatCustomerUI();
      uploadedMediaUrls = [];
      if (mediaUrls){ mediaUrls.style.display='none'; mediaUrls.textContent=''; }
      if (mediaUploadStatus){ mediaUploadStatus.style.display='none'; mediaUploadStatus.textContent=''; }
      if (!keepLookupPhone) lookupPhone.value='';
    }

    function clearResult(){
      resultContainer.innerHTML = '<p class="result-placeholder">Use Customer Lookup first, then click <strong>Generate AI</strong>.</p>';
    }

    newCustomerBtn.addEventListener('click', () => {
      clearIntake(true);
      setTopStatus('New intake ready. Use Lookup if needed.','');
      clearResult();
      currentJob = null;
      updateJobPill();
    });

    function normalizePhone(s){ return String(s || '').replace(/\s+/g,'').trim(); }

    async function openHistoryJob(jobId){
      if (!(await ensureLoggedIn())) return;
      if (!jobId) return;

      try{
        const token = getToken();
        const res = await fetch(API_BASE_URL + '/api/jobs/' + encodeURIComponent(jobId), {
          headers:{ Authorization:'Bearer ' + token }
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok){
          Swal.fire('Load failed', (data && (data.error || data.message)) || 'Load failed.', 'error');
          return;
        }

        const job = data.job;
        if (!job){
          Swal.fire('Load failed','No job returned.','error');
          return;
        }

        currentJob = job;
        updateJobPill();
        setWorkflow(currentJob.status || 'in_progress');
        renderDashboard(currentJob);

        Swal.fire('Loaded','History job loaded.','success');
      } catch {
        Swal.fire('Load failed','Network error.','error');
      }
    }

    function escapeHtml(str){
      return String(str || '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function renderVehicleSelector(vehicles){
      lastLookupVehicles = Array.isArray(vehicles) ? vehicles : [];
      if (!repeatExtras || !vehicleSelect || !vehicleSelectHint) return;

      if (!lastLookupVehicles.length){
        repeatExtras.style.display='none';
        vehicleSelect.innerHTML='<option value="">Select vehicle</option>';
        vehicleSelectHint.textContent='';
        return;
      }

      repeatExtras.style.display='block';
      vehicleSelect.innerHTML='<option value="">Select vehicle</option>';

      lastLookupVehicles.forEach((v, idx) => {
        const label = [v.year, v.make, v.model].filter(Boolean).join(' ').trim() || 'Vehicle';
        const plateTxt = v.plate ? (' Â· ' + v.plate) : '';
        const vinTxt = v.vin ? (' Â· ' + (String(v.vin).slice(0,6) + 'â€¦' + String(v.vin).slice(-4))) : '';
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = label + plateTxt + vinTxt;
        vehicleSelect.appendChild(opt);
      });

      vehicleSelect.value='0';
      vehicleSelectHint.textContent='Select a vehicle to populate VIN/plate/year/make/model.';
    }

    function applyVehicleToForm(v){
      if (!v) return;
      vin.value = v.vin || '';
      plate.value = v.plate || '';
      year.value = v.year || '';
      make.value = v.make || '';
      model.value = v.model || '';
      engine.value = v.engine || '';
      const t = (v.transmission || '').toUpperCase();
      if (['AT','MT','CVT','DCT'].includes(t)) transmission.value = t;
      else if (t) transmission.value = 'Other';
      else transmission.value = '';
      dropOffDate.value = (v.dropOffDate || '').slice(0,10);
    }

    function renderHistoryList(history){
      if (!historyList || !historyListHint) return;
      historyList.innerHTML='';
      const arr = Array.isArray(history) ? history : [];
      if (!arr.length){
        historyList.innerHTML='<div class="hint">No previous jobs found.</div>';
        historyListHint.textContent='';
        return;
      }

      arr.slice(0,10).forEach((h) => {
        const card = document.createElement('div');
        card.className='card';
        card.style.padding='0.75rem';
        card.style.border='1px solid rgba(255,255,255,.10)';
        card.style.background='rgba(255,255,255,.03)';

        const title = h.mostLikelyIssue || (h.aiResult && h.aiResult.mostLikelyIssue) || 'â€”';
        const status = String(h.status || 'in_progress').replace('_',' ');
        const when = h.createdAt ? new Date(h.createdAt).toLocaleString() : 'â€”';
        const conf = (h.confidenceLevel ?? (h.aiResult && h.aiResult.confidenceLevel));

        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:0.75rem; align-items:flex-start;">
            <div style="min-width:0;">
              <div style="font-weight:800; line-height:1.15; word-break:break-word;">${escapeHtml(title)}</div>
              <div class="hint" style="margin-top:0.4rem;">
                ${escapeHtml(status)} Â· ${escapeHtml(when)}${conf !== undefined && conf !== null ? (' Â· Confidence: ' + escapeHtml(String(conf)) + '%') : ''}
              </div>
            </div>
            <button class="btn btn-ghost" type="button">Open</button>
          </div>
        `;
        card.querySelector('button').addEventListener('click', () => openHistoryJob(h.id));
        historyList.appendChild(card);
      });

      historyListHint.textContent='Click Open to load a past job into the result panel.';
    }

    if (vehicleSelect){
      vehicleSelect.addEventListener('change', () => {
        const idx = Number(vehicleSelect.value);
        if (!Number.isFinite(idx)) return;
        const v = lastLookupVehicles[idx];
        if (!v) return;
        applyVehicleToForm(v);
      });
    }

    lookupBtn.addEventListener('click', async () => {
      if (!(await ensureLoggedIn())) return;
      const p = normalizePhone(lookupPhone.value);
      if (!p){ setTopStatus('Enter a phone number to lookup.','error'); return; }

      setTopStatus('Looking up customer...','loading');
      resetRepeatCustomerUI();

      try{
        const token = getToken();
        const res = await fetch(API_BASE_URL + '/api/customers/lookup?phone=' + encodeURIComponent(p), {
          headers:{ Authorization:'Bearer ' + token }
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok){
          setTopStatus((data && data.error) ? data.error : 'Lookup failed.','error');
          return;
        }

        if (!data.found){
          clearIntake(true);
          phone.value = p;
          setTopStatus('No existing customer found. Intake fields are blank.','');
          return;
        }

        const c = data.customer || {};
        fullName.value = c.fullName || '';
        phone.value = c.phone || p;
        email.value = c.email || '';
        preferredContactMethod.value = (c.preferredContactMethod === 'email') ? 'email' : 'text';
        repeatCustomerPill.style.display='inline-flex';

        const vehicles = Array.isArray(data.vehicles) ? data.vehicles : [];
        if (vehicles.length > 0) applyVehicleToForm(vehicles[0]);
        renderVehicleSelector(vehicles);

        const history = Array.isArray(data.history) ? data.history : [];
        renderHistoryList(history);
        if (history.length > 0){
          historyHint.style.display='block';
          const last = history[0];
          const lastStatus = (last.status || '').replace('_',' ');
          historyHint.textContent = 'History: ' + history.length + ' job(s). Latest status: ' + lastStatus + '.';
        }

        setTopStatus('Customer found. Details auto-filled.','');
      } catch {
        setTopStatus('Network error during lookup.','error');
      }
    });

    /* =========================
       VIN DECODE
       ========================= */
    const decodeVinBtn = document.getElementById('decodeVinBtn');
    function setVinStatus(msg){ vinStatus.textContent = msg || ''; }

    decodeVinBtn.addEventListener('click', async () => {
      if (!(await ensureLoggedIn())) return;

      const v = String(vin.value || '').trim();
      if (!v){ setVinStatus('Enter a VIN first.'); return; }

      setVinStatus('Decoding VIN...');
      try{
        const token = getToken();
        const res = await fetch(API_BASE_URL + '/api/vin/decode?vin=' + encodeURIComponent(v), {
          headers:{ Authorization:'Bearer ' + token }
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok){
          setVinStatus((data && data.error) ? data.error : 'VIN decode failed.');
          return;
        }

        const d = data.decoded || {};
        if (d.year) year.value = d.year;
        if (d.make) make.value = d.make;
        if (d.model) model.value = d.model;
        if (d.engine) engine.value = d.engine;
        if (d.transmission){
          const t = String(d.transmission).toUpperCase();
          if (['AT','MT','CVT','DCT'].includes(t)) transmission.value = t;
          else transmission.value = 'Other';
        }
        setVinStatus('VIN decoded. Fields updated.');
      } catch {
        setVinStatus('Network error during VIN decode.');
      }
    });

    /* =========================
       JOB + AI FLOW
       ========================= */
    const resultContainer = document.getElementById('resultContainer');
    const jobIdPill = document.getElementById('jobIdPill');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const demoBtn = document.getElementById('demoBtn');

    let currentJob = null;

    function updateJobPill(){
      const id = currentJob && (currentJob._id || currentJob.id);
      if (id){
        jobIdPill.style.display='inline-flex';
        jobIdPill.textContent='Job: ' + String(id).slice(-8);
      } else {
        jobIdPill.style.display='none';
        jobIdPill.textContent='Job: â€”';
      }
    }

    function likelihoodClass(l){
      const s = String(l || '').toLowerCase();
      if (s === 'high') return 'likelihood-high';
      if (s === 'medium') return 'likelihood-medium';
      if (s === 'low') return 'likelihood-low';
      return '';
    }

    function safeNumber(n, fallback=0){
      const x = Number(n);
      return Number.isFinite(x) ? x : fallback;
    }

    function normalizeTextOrInsufficient(v){
      const t = String(v ?? '').trim();
      return t ? t : 'Insufficient data';
    }

    function setConfidenceUI(){
      const input = document.getElementById('editConfidence');
      const bar = document.getElementById('confidenceBar');
      const pct = document.getElementById('confidencePct');
      if (!input || !bar || !pct) return;

      const val = Math.max(0, Math.min(100, safeNumber(input.value, 0)));
      bar.style.width = val + '%';
      pct.textContent = val + '%';
    }

    // âœ… FIX 1: add Most Likely Issue editor (was referenced but missing)
    // âœ… FIX 2: per-cause labor save supported (frontend stores editable fields)
    // âœ… FIX 3: summary endpoint call now matches backend routes (/summary/customer | /summary/mechanic)
    // âœ… FIX 4: summary response supports backend returning {summary} (string or object)
    function renderDashboard(job){
      if (!job){ clearResult(); return; }

      const ai = job.aiResult || {};
      const causes = Array.isArray(ai.probableCauses) ? ai.probableCauses : [];

      let html = '';

      html += `
        <div class="result-block">
          <h3>AI Diagnostic Result</h3>
          <div class="kv">

            <div class="kv-row">
              <div>
                <label>Most Likely Issue (editable)</label>
                <input id="editMostLikelyIssue" type="text" value="${escapeHtml(ai.mostLikelyIssue || '')}" placeholder="(blank)" />
                <div class="hint">This is the headline shown in summaries.</div>
              </div>

              <div>
                <label>Status</label>
                <input type="text" value="${escapeHtml(job.status || '')}" disabled />
              </div>
            </div>

            <div class="kv-row">
              <div>
                <label>Confidence Level</label>
                <div class="progress-wrap">
                  <div class="progress-top">
                    <div class="progress-pct" id="confidencePct">0%</div>
                    <div style="display:flex; gap:.5rem; align-items:center; justify-content:flex-end;">
                      <span class="pill">editable</span>
                    </div>
                  </div>
                  <div class="progress-track"><div class="progress-bar" id="confidenceBar"></div></div>
                  <input id="editConfidence" type="number" min="0" max="100" value="${safeNumber(ai.confidenceLevel, 0)}" />
                  <div class="hint">Progress bar reflects the editable % value above.</div>
                </div>
              </div>

              <div>
                <label>Estimated Labor (overall, hours)</label>
                <input id="editLaborHours" type="number" step="0.1" min="0" value="${safeNumber(ai.estimatedLaborHours, 0)}" />
                <div class="hint">Overall estimate (separate from per-cause labor below).</div>
              </div>
            </div>

          </div>
        </div>
      `;

      html += `<div class="result-block"><h3>Probable Causes</h3>`;

      if (!causes.length){
        html += `<p class="result-placeholder">Insufficient data</p>`;
      } else {
        causes.forEach((c, idx) => {
          const title = c.title || ('Cause ' + (idx + 1));
          const likelihood = (c.likelihood || 'medium');
          const severity = c.severity || 'Insufficient data';

          const recTestText =
            (c.recommendedTesting && typeof c.recommendedTesting === 'string')
              ? c.recommendedTesting
              : (c.recommendedTesting && c.recommendedTesting.steps)
                ? c.recommendedTesting.steps
                : (c.recommendedTesting && c.recommendedTesting.text)
                  ? c.recommendedTesting.text
                  : '';

          const recTestTime =
            (c.recommendedTesting && typeof c.recommendedTesting === 'object')
              ? (c.recommendedTesting.timeMinutes ?? c.recommendedTesting.timeMins ?? c.recommendedTesting.minutes)
              : (c.testingTimeMinutes ?? c.testingTimeMins ?? c.testingMinutes);

          const partsIfConfirmed = Array.isArray(c.partsNeededIfConfirmed)
            ? c.partsNeededIfConfirmed
            : (Array.isArray(c.partsNeeded) ? c.partsNeeded : []);

          const partsListHtml = partsIfConfirmed.length
            ? ('<ul style="margin:.35rem 0 0; padding-left:1.1rem; color:var(--text-muted); font-size:.9rem; line-height:1.6;">' +
                partsIfConfirmed.map(p => '<li>' + escapeHtml(String(p)) + '</li>').join('') +
               '</ul>')
            : '<div class="hint" style="margin-top:.35rem;">Insufficient data</div>';

          const estLaborIfConfirmed = safeNumber(c.estimatedLaborHoursIfConfirmed ?? c.estimatedLabourHoursIfConfirmed ?? c.estimatedLaborHours, 0);

          html += `
            <div class="cause-item ${likelihoodClass(likelihood)}" data-cause-idx="${idx}">
              <div class="cause-header">
                <div style="min-width:0;">
                  <div class="cause-title">${escapeHtml(title)}</div>
                  <div class="hint" style="margin-top:.25rem;">${escapeHtml(normalizeTextOrInsufficient(c.explanation))}</div>
                </div>
                <div style="display:flex; flex-direction:column; gap:.35rem; align-items:flex-end;">
                  <span class="pill">${escapeHtml(String(likelihood).toUpperCase())}</span>
                  <span class="pill">Severity: ${escapeHtml(String(severity))}</span>
                </div>
              </div>

              <div class="divider" style="margin:.6rem 0;"></div>

              <div class="kv" style="gap:.75rem;">
                <div>
                  <label>Recommended Testing (not editable)</label>
                  <div class="result-text" style="margin-top:.25rem;">
                    ${escapeHtml(normalizeTextOrInsufficient(recTestText))}
                    ${recTestTime !== undefined && recTestTime !== null && String(recTestTime).trim() !== ''
                      ? ('<div class="hint" style="margin-top:.35rem;">Testing time: ' + escapeHtml(String(recTestTime)) + ' mins</div>')
                      : '<div class="hint" style="margin-top:.35rem;">Testing time: Insufficient data</div>'
                    }
                  </div>
                </div>

                <div>
                  <label>Parts Needed (If Test confirms) (not editable)</label>
                  ${partsListHtml}
                </div>

                <div class="kv-row">
                  <div>
                    <label>Estimated Labour (If confirmed, hours) (editable)</label>
                    <input id="causeLabor_${idx}" type="number" step="0.1" min="0" value="${estLaborIfConfirmed}" />
                    <div class="hint">Saved per-cause in AI result (if backend supports).</div>
                  </div>

                  <div>
                    <label>Severity (not editable)</label>
                    <input type="text" value="${escapeHtml(String(severity))}" disabled />
                  </div>
                </div>
              </div>
            </div>
          `;
        });
      }
      html += `</div>`;

      html += `
        <div class="result-block">
          <h3>Mechanic Notes &amp; Schedule</h3>
          <div class="kv">
            <div>
              <label>Additional Mechanic Notes</label>
              <textarea id="editMechanicNotes" rows="3" placeholder="(blank)">${escapeHtml(ai.additionalMechanicNotes || '')}</textarea>
            </div>

            <div class="kv-row">
              <div>
                <label>Estimated Pickup Date (optional)</label>
                <input id="editPickupDate" type="date" value="${(ai.estimatedPickupDate || '').slice(0,10)}" />
              </div>
              <div>
                <label>Current Status</label>
                <input type="text" value="${escapeHtml(job.status || '')}" disabled />
              </div>
            </div>
          </div>
        </div>
      `;

      html += `
        <div class="result-actions">
          <a class="linkish" href="javascript:void(0)" id="customerSummaryLink">Generate a customer summary</a>
          <a class="linkish" href="javascript:void(0)" id="mechanicSummaryLink">Generate a mechanic summary</a>
        </div>

        <div class="divider"></div>

        <div class="result-actions">
          <button type="button" class="btn btn-success" id="approveBtn">Approve Work</button>
          <button type="button" class="btn btn-danger" id="declineBtn">Decline Work</button>
          <button type="button" class="btn btn-primary" id="saveBtn">Save</button>
        </div>

        <div class="meta-line" id="generatedMeta">
          ${job.generatedOn ? ('Generated on ' + escapeHtml(job.generatedOn)) : ''}
        </div>

        <div id="summaryBox" style="margin-top:0.75rem;"></div>

        <div class="disclaimer">
          <strong>Disclaimer:</strong> This AI output is an estimate, not a confirmed diagnosis. Always confirm via testing and professional inspection.
        </div>
      `;

      resultContainer.innerHTML = html;

      document.getElementById('approveBtn').addEventListener('click', () => changeStatus('completed'));
      document.getElementById('declineBtn').addEventListener('click', async () => {
        const r = await Swal.fire({
          title: 'Decline Work?',
          text: 'Add optional notes (recommended).',
          icon: 'warning',
          input: 'textarea',
          inputPlaceholder: 'Optional notes...',
          showCancelButton: true,
          confirmButtonText: 'Decline',
          cancelButtonText: 'Cancel',
          reverseButtons: true,
        });
        if (!r.isConfirmed) return;
        changeStatus('cancelled', r.value || '');
      });

      document.getElementById('saveBtn').addEventListener('click', () => saveEdits());
      document.getElementById('customerSummaryLink').addEventListener('click', () => generateSummary('customer'));
      document.getElementById('mechanicSummaryLink').addEventListener('click', () => generateSummary('mechanic'));

      setConfidenceUI();
      const confInput = document.getElementById('editConfidence');
      confInput.addEventListener('input', setConfidenceUI);
      confInput.addEventListener('change', setConfidenceUI);
    }

    function getMediaPayload(){
      const urls = Array.isArray(uploadedMediaUrls) ? uploadedMediaUrls : [];
      return urls.slice(0,25).map(u => ({
        kind: String(u || '').match(/\.(mp4|mov|avi|mkv|webm)$/i) ? 'video' : 'photo',
        url: u
      }));
    }

    function buildJobPayload(){
      return {
        customer:{
          fullName: fullName.value.trim(),
          phone: phone.value.trim(),
          email: email.value.trim(),
          preferredContactMethod: preferredContactMethod.value
        },
        vehicle:{
          vin: vin.value.trim(),
          plate: plate.value.trim(),
          year: year.value.trim(),
          make: make.value.trim(),
          model: model.value.trim(),
          engine: engine.value.trim(),
          transmission: transmission.value,
          dropOffDate: dropOffDate.value
        },
        diagnostic:{
          obd2Data: obd2Data.value.trim(),
          symptoms: symptoms.value.trim(),
          media: getMediaPayload()
        },
        preferences:{
          detailLevel: detailLevel.value,
          language: language.value,
          tone: tone.value,
          aiPolicy: AI_MODEL_POLICY
        }
      };
    }

    async function createJobAndGenerate(){
      if (!(await ensureLoggedIn())) return;

      const p = buildJobPayload();
      if (!p.customer.phone){
        setFormStatus('Phone number is required (lookup or manual).','error');
        return;
      }
      if (!p.diagnostic.symptoms){
        setFormStatus('Describe the symptoms first.','error');
        return;
      }

      generateBtn.disabled = true;
      clearBtn.disabled = true;
      demoBtn.disabled = true;
      lookupBtn.disabled = true;
      newCustomerBtn.disabled = true;

      setFormStatus('Generating AI draft...','loading');
      setTopStatus('','');

      try{
        const token = getToken();
        const res = await fetch(API_BASE_URL + '/api/jobs', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', Authorization:'Bearer ' + token },
          body: JSON.stringify(p)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok){
          const msg = (data && (data.error || data.message)) ? (data.error || data.message) : 'Failed to create job.';
          setFormStatus(msg,'error');
          return;
        }

        currentJob = data.job;
        updateJobPill();
        setWorkflow(currentJob.status || 'in_progress');

        setFormStatus('','');
        renderDashboard(currentJob);
      } catch {
        setFormStatus('Network error calling /api/jobs.','error');
      } finally {
        generateBtn.disabled = false;
        clearBtn.disabled = false;
        demoBtn.disabled = false;
        lookupBtn.disabled = false;
        newCustomerBtn.disabled = false;
      }
    }

    // NOTE: this will only persist if backend accepts probableCauses edits
    function readPerCauseLaborFromUI(){
      if (!currentJob || !currentJob.aiResult) return [];
      const causes = Array.isArray(currentJob.aiResult.probableCauses) ? currentJob.aiResult.probableCauses : [];
      return causes.map((c, idx) => {
        const el = document.getElementById('causeLabor_' + idx);
        const v = el ? Number(el.value || 0) : (c.estimatedLaborHoursIfConfirmed ?? c.estimatedLabourHoursIfConfirmed ?? 0);
        return { ...c, estimatedLaborHoursIfConfirmed: safeNumber(v, 0) };
      });
    }

    async function saveEdits(){
      if (!(await ensureLoggedIn())) return;
      if (!currentJob) return;

      const jobId = currentJob._id || currentJob.id;
      if (!jobId) return;

      const mostLikelyIssueEl = document.getElementById('editMostLikelyIssue');
      const confidenceEl = document.getElementById('editConfidence');
      const laborEl = document.getElementById('editLaborHours');
      const notesEl = document.getElementById('editMechanicNotes');
      const pickupEl = document.getElementById('editPickupDate');

      const updatedCauses = readPerCauseLaborFromUI();

      const payload = {
        aiResult: {
          mostLikelyIssue: (mostLikelyIssueEl ? mostLikelyIssueEl.value : ''),
          confidenceLevel: safeNumber(confidenceEl ? confidenceEl.value : 0, 0),
          estimatedLaborHours: safeNumber(laborEl ? laborEl.value : 0, 0),
          additionalMechanicNotes: (notesEl ? notesEl.value : ''),
          estimatedPickupDate: (pickupEl ? pickupEl.value : '') || '',
          probableCauses: updatedCauses
        }
      };

      setTopStatus('Saving...','loading');

      try{
        const token = getToken();
        const res = await fetch(API_BASE_URL + '/api/jobs/' + encodeURIComponent(jobId), {
          method:'PATCH',
          headers:{ 'Content-Type':'application/json', Authorization:'Bearer ' + token },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok){
          setTopStatus((data && (data.error || data.message)) ? (data.error || data.message) : 'Save failed.','error');
          return;
        }

        currentJob = data.job || currentJob;
        updateJobPill();
        setTopStatus('Saved.','');
        renderDashboard(currentJob);
      } catch {
        setTopStatus('Network error while saving.','error');
      }
    }

    async function changeStatus(status, cancelNotes=''){
      if (!(await ensureLoggedIn())) return;
      if (!currentJob) return;

      const jobId = currentJob._id || currentJob.id;
      if (!jobId) return;

      setTopStatus('Updating status...','loading');

      try{
        const token = getToken();
        const payload = { status, cancelNotes };
        const res = await fetch(API_BASE_URL + '/api/jobs/' + encodeURIComponent(jobId), {
          method:'PATCH',
          headers:{ 'Content-Type':'application/json', Authorization:'Bearer ' + token },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok){
          setTopStatus((data && (data.error || data.message)) ? (data.error || data.message) : 'Status update failed.','error');
          return;
        }

        currentJob = data.job || currentJob;
        updateJobPill();
        setWorkflow(currentJob.status || status);
        setTopStatus('Status updated.','');
        renderDashboard(currentJob);
      } catch {
        setTopStatus('Network error updating status.','error');
      }
    }

    // âœ… FIX: correct summary routes + robust response handling
    async function generateSummary(kind){
      if (!(await ensureLoggedIn())) return;
      if (!currentJob) return;

      const jobId = currentJob._id || currentJob.id;
      if (!jobId) return;

      const summaryBox = document.getElementById('summaryBox');
      summaryBox.innerHTML = '<div class="result-block"><h3>Summary</h3><p class="result-placeholder">Generating...</p></div>';

      const endpoint =
        kind === 'customer'
          ? (API_BASE_URL + '/api/jobs/' + encodeURIComponent(jobId) + '/summary/customer')
          : (API_BASE_URL + '/api/jobs/' + encodeURIComponent(jobId) + '/summary/mechanic');

      try{
        const token = getToken();
        const res = await fetch(endpoint, {
          method:'POST',
          headers:{ 'Content-Type':'application/json', Authorization:'Bearer ' + token }
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok){
          summaryBox.innerHTML =
            '<div class="result-block"><h3>Summary</h3><p class="result-placeholder">' +
            escapeHtml((data && (data.error || data.message)) ? (data.error || data.message) : 'Failed to generate summary.') +
            '</p></div>';
          return;
        }

        // backend may return:
        // - { summary: "string..." }
        // - { summary: {...object...} }
        // - { text: "..." } (older)
        const payload = (data.summary !== undefined) ? data.summary : (data.text !== undefined ? data.text : data);

        const title = (kind === 'customer' ? 'Customer Summary' : 'Mechanic Summary');
        const txt =
          (typeof payload === 'string')
            ? payload
            : JSON.stringify(payload, null, 2);

        summaryBox.innerHTML =
          '<div class="result-block">' +
            '<h3>' + title + '</h3>' +
            '<pre>' + escapeHtml(txt || '') + '</pre>' +
          '</div>';
      } catch {
        summaryBox.innerHTML =
          '<div class="result-block"><h3>Summary</h3><p class="result-placeholder">Network error.</p></div>';
      }
    }

    /* =========================
       BUTTONS
       ========================= */
    generateBtn.addEventListener('click', createJobAndGenerate);

    clearBtn.addEventListener('click', () => {
      clearIntake(true);
      clearResult();
      currentJob = null;
      updateJobPill();
      setTopStatus('Cleared.','');
    });

    demoBtn.addEventListener('click', () => {
      fullName.value = 'Juan Dela Cruz';
      phone.value = '09171234567';
      email.value = 'juan.delacruz@example.com';
      preferredContactMethod.value = 'text';

      vin.value = 'WVWZZZ1JZXW000001';
      plate.value = 'ABC 1234';
      year.value = '';
      make.value = '';
      model.value = '';
      engine.value = '';
      transmission.value = 'AT';
      dropOffDate.value = '2026-01-03';

      obd2Data.value = 'DTC: P0302 (Cylinder 2 Misfire)\\nSTFT: +12%\\nLTFT: +8%\\nMisfire count cyl2 increasing at idle.';
      symptoms.value = 'Rough idle and intermittent check engine light. Power loss on acceleration. Started last week after heavy rain.';

      detailLevel.value = 'Detailed';
      language.value = 'English';
      tone.value = 'More Technical';

      setFormStatus('Demo data filled. Click Generate AI.','');
      clearResult();
    });

    /* =========================
       INIT
       ========================= */
    (async function init(){
      setWorkflow('in_progress');
      clearResult();
      updateJobPill();

      const ok = await ensureLoggedIn();
      if (!ok) return;
      await loadWelcome();
    })();
  </script>
</body>
</html>